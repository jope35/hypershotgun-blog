<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joost de Theije + LLM">
<meta name="dcterms.date" content="2024-03-14">

<title>hyper-shotgun - pooking and looking ðŸ‘€</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicons/hyper_favi.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../apple-touch-icon.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">hyper-shotgun</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../whois.html"> 
<span class="menu-text">whois ðŸ¤–</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/joostdetheije/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text">LinkedIn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/jope35"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">Github</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">pooking and looking ðŸ‘€</h1>
            <p class="subtitle lead">diving into partial dependence plots</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Joost de Theije + LLM </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 14, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="header-section-number">1</span> Intro</a></li>
  <li><a href="#how-to-calculate-the-pdp" id="toc-how-to-calculate-the-pdp" class="nav-link" data-scroll-target="#how-to-calculate-the-pdp"><span class="header-section-number">2</span> how to calculate the PDP</a>
  <ul class="collapse">
  <li><a href="#determine-the-range-of-x_0" id="toc-determine-the-range-of-x_0" class="nav-link" data-scroll-target="#determine-the-range-of-x_0"><span class="header-section-number">2.1</span> determine the range of <code>x_0</code></a></li>
  <li><a href="#set-a-grid-size-i.e-the-sampling-ratio-over-the-range" id="toc-set-a-grid-size-i.e-the-sampling-ratio-over-the-range" class="nav-link" data-scroll-target="#set-a-grid-size-i.e-the-sampling-ratio-over-the-range"><span class="header-section-number">2.2</span> set a grid size, i.e the sampling ratio over the range</a></li>
  <li><a href="#apply-the-grid-over-the-data" id="toc-apply-the-grid-over-the-data" class="nav-link" data-scroll-target="#apply-the-grid-over-the-data"><span class="header-section-number">2.3</span> apply the grid over the data</a></li>
  <li><a href="#predict-with-the-model" id="toc-predict-with-the-model" class="nav-link" data-scroll-target="#predict-with-the-model"><span class="header-section-number">2.4</span> predict with the model</a></li>
  <li><a href="#average-out-the-individual-predictions" id="toc-average-out-the-individual-predictions" class="nav-link" data-scroll-target="#average-out-the-individual-predictions"><span class="header-section-number">2.5</span> average out the individual predictions</a></li>
  </ul></li>
  <li><a href="#scikit-learn-implementation" id="toc-scikit-learn-implementation" class="nav-link" data-scroll-target="#scikit-learn-implementation"><span class="header-section-number">3</span> Scikit-learn implementation</a>
  <ul class="collapse">
  <li><a href="#one-way-partial-dependence" id="toc-one-way-partial-dependence" class="nav-link" data-scroll-target="#one-way-partial-dependence"><span class="header-section-number">3.1</span> one-way partial dependence</a></li>
  <li><a href="#two-way-partial-dependence" id="toc-two-way-partial-dependence" class="nav-link" data-scroll-target="#two-way-partial-dependence"><span class="header-section-number">3.2</span> two-way partial dependence</a></li>
  </ul></li>
  <li><a href="#bonus-individual-conditional-expectation" id="toc-bonus-individual-conditional-expectation" class="nav-link" data-scroll-target="#bonus-individual-conditional-expectation"><span class="header-section-number">4</span> Bonus: Individual Conditional Expectation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<ul>
<li>generate data</li>
<li>train rf</li>
<li>create pdp, and determine monotonic relations</li>
</ul>
<div id="cell-2" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">from</span> matplotlib_inline.backend_inline <span class="im">import</span> set_matplotlib_formats</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_friedman1</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> PartialDependenceDisplay, partial_dependence</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-3" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">UserWarning</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-4" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># setting global plotting settings</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># roudning all floats to two digits</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">"</span><span class="sc">{:.2f}</span><span class="st">"</span>.<span class="bu">format</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>set_matplotlib_formats(<span class="st">"svg"</span>)</span>
<span id="cb3-6"><a href="#cb3-6"></a>sns.set_context(context<span class="op">=</span><span class="st">"notebook"</span>, font_scale<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a>sns.set_palette(<span class="st">"tab10"</span>)</span>
<span id="cb3-8"><a href="#cb3-8"></a>sns.set_style(<span class="st">"darkgrid"</span>)</span>
<span id="cb3-9"><a href="#cb3-9"></a>FIGSIZE <span class="op">=</span> (<span class="dv">12</span>, <span class="dv">6</span>)</span>
<span id="cb3-10"><a href="#cb3-10"></a>RANDOM_STATE <span class="op">=</span> <span class="dv">35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="intro" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="intro"><span class="header-section-number">1</span> Intro</h2>
<p>Today, weâ€™re examining partial dependence plots, a tool for visualizing the average influence of a feature on a modelâ€™s predictions.</p>
<p>#TODO why would we want to see a partial dependece plot</p>
<p>To demonstrate this, weâ€™ll utilize a dataset from Scikit-learn, which can be found <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.make_friedman1.html#sklearn.datasets.make_friedman1">here</a>.</p>
<p>The formula generating the synthetic dataset is as follows: <span class="math inline">\(y(X) = 10\sin(\pi \cdot X_0 \cdot X_1) + 20 \cdot (X_2 - 0.5)^2 + 10 \cdot X_3 + 5 \cdot X_4 + \text{noise} \cdot N(0, 1)\)</span>.</p>
<p>I will generate a dataset comprising 7 features, but only 5 will actually influence the outputâ€”meaning the remaining two have no predictive value. the generate dataset contains 2000 samples and has a noise factor of 2.</p>
<div id="cell-6" class="cell" data-execution_count="4">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>X_reg, y_reg <span class="op">=</span> make_friedman1(</span>
<span id="cb4-2"><a href="#cb4-2"></a>    n_samples<span class="op">=</span><span class="dv">2_000</span>, n_features<span class="op">=</span><span class="dv">7</span>, noise<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span>RANDOM_STATE</span>
<span id="cb4-3"><a href="#cb4-3"></a>)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># stick it into a dataframe</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>df_reg <span class="op">=</span> pd.concat(</span>
<span id="cb4-7"><a href="#cb4-7"></a>    [</span>
<span id="cb4-8"><a href="#cb4-8"></a>        pd.DataFrame(</span>
<span id="cb4-9"><a href="#cb4-9"></a>            data<span class="op">=</span>X_reg, columns<span class="op">=</span>[<span class="st">"x_0"</span>, <span class="st">"x_1"</span>, <span class="st">"x_2"</span>, <span class="st">"x_3"</span>, <span class="st">"x_4"</span>, <span class="st">"x_5"</span>, <span class="st">"x_6"</span>]</span>
<span id="cb4-10"><a href="#cb4-10"></a>        ),</span>
<span id="cb4-11"><a href="#cb4-11"></a>        pd.DataFrame(data<span class="op">=</span>y_reg, columns<span class="op">=</span>[<span class="st">"target"</span>]),</span>
<span id="cb4-12"><a href="#cb4-12"></a>    ],</span>
<span id="cb4-13"><a href="#cb4-13"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-14"><a href="#cb4-14"></a>)</span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># display descriptive stats</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>df_reg.describe().T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">x_0</td>
<td>2000.00</td>
<td>0.49</td>
<td>0.29</td>
<td>0.00</td>
<td>0.25</td>
<td>0.49</td>
<td>0.74</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">x_1</td>
<td>2000.00</td>
<td>0.50</td>
<td>0.29</td>
<td>0.00</td>
<td>0.25</td>
<td>0.51</td>
<td>0.76</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">x_2</td>
<td>2000.00</td>
<td>0.50</td>
<td>0.29</td>
<td>0.00</td>
<td>0.25</td>
<td>0.52</td>
<td>0.75</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">x_3</td>
<td>2000.00</td>
<td>0.50</td>
<td>0.28</td>
<td>0.00</td>
<td>0.26</td>
<td>0.51</td>
<td>0.75</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">x_4</td>
<td>2000.00</td>
<td>0.50</td>
<td>0.29</td>
<td>0.00</td>
<td>0.25</td>
<td>0.50</td>
<td>0.75</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">x_5</td>
<td>2000.00</td>
<td>0.50</td>
<td>0.29</td>
<td>0.00</td>
<td>0.24</td>
<td>0.49</td>
<td>0.75</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">x_6</td>
<td>2000.00</td>
<td>0.50</td>
<td>0.28</td>
<td>0.00</td>
<td>0.26</td>
<td>0.51</td>
<td>0.75</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">target</td>
<td>2000.00</td>
<td>14.48</td>
<td>5.26</td>
<td>-1.56</td>
<td>10.72</td>
<td>14.46</td>
<td>18.15</td>
<td>30.51</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>all input features are uniform distributed <span class="math inline">\(U(0,1)\)</span> -&gt; the mean is ~0.5 the target feature has a higher mean of ~14</p>
<p>The data is fed into a random-forest model, <a href="https://www.linkedin.com/feed/update/urn:li:activity:7169278449243607041?updateEntityUrn=urn%3Ali%3Afs_feedUpdate%3A%28V2%2Curn%3Ali%3Aactivity%3A7169278449243607041%29">it is my favorite go to model</a>, no feature scaling required can handle missing values, can capture non-linearity, has ability to model non-linearity, and fitting can be quite fast.</p>
<div id="cell-8" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>X <span class="op">=</span> df_reg.drop(columns<span class="op">=</span><span class="st">"target"</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a>y <span class="op">=</span> df_reg[<span class="st">"target"</span>]</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a>reg <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb5-5"><a href="#cb5-5"></a>    n_estimators<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>    max_depth<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>    min_samples_split<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb5-8"><a href="#cb5-8"></a>    random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb5-9"><a href="#cb5-9"></a>)</span>
<span id="cb5-10"><a href="#cb5-10"></a>_ <span class="op">=</span> reg.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>to determine the partial dependence (PD) of each feature on the target we need to do some dataset wrangling. lets start with a (very very small) subset of our data taken at random.</p>
<div id="cell-10" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>df_sample <span class="op">=</span> df_reg.sample(<span class="dv">3</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>df_sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x_0</th>
<th data-quarto-table-cell-role="th">x_1</th>
<th data-quarto-table-cell-role="th">x_2</th>
<th data-quarto-table-cell-role="th">x_3</th>
<th data-quarto-table-cell-role="th">x_4</th>
<th data-quarto-table-cell-role="th">x_5</th>
<th data-quarto-table-cell-role="th">x_6</th>
<th data-quarto-table-cell-role="th">target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">674</td>
<td>0.36</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1699</td>
<td>0.32</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1282</td>
<td>0.31</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="how-to-calculate-the-pdp" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="how-to-calculate-the-pdp"><span class="header-section-number">2</span> how to calculate the PDP</h2>
<p>In order to calculate the PD of lets say <code>x_0</code> we would need to follow these steps: 1. determine the range of <code>x_0</code> 2. set a grid size, i.e the sampling ratio over the range 3. apply the grid over the data, this will increase the data size by a lot 4. predict with the model using the newly created dataset 5. average out the individual predictions to get a singular result</p>
<ol type="1">
<li>range of <code>x_0</code> is between 0 and 1</li>
<li>lets use a grid size of 7, that means that we create a list of 7 equaly space values between 0 and 1</li>
<li>for each sample in our dataset we apply the grid of 7 values which means that if we have 3 datapoints to begin we end up with 3*7=21 datapoints. that is an increase in data and for bigger data sets and finer grids this increases very fast</li>
<li>now we ask the model to make predictions, this is inference and not training so the computational cost is reasonable</li>
<li>perform a group by on the sampled grid and apply a average aggregation function</li>
<li>the result is the partial dependence of <code>x_0</code> and the target variable</li>
</ol>
<section id="determine-the-range-of-x_0" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="determine-the-range-of-x_0"><span class="header-section-number">2.1</span> determine the range of <code>x_0</code></h3>
<div id="cell-13" class="cell" data-execution_count="7">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>df_reg[<span class="st">"x_0"</span>].agg([<span class="st">"min"</span>, <span class="st">"max"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>min   0.00
max   1.00
Name: x_0, dtype: float64</code></pre>
</div>
</div>
<p>the range of <code>x_0</code> is between zero and one, in this case we are taking the entire region but you could also restrict it to the 90% percentile.</p>
</section>
<section id="set-a-grid-size-i.e-the-sampling-ratio-over-the-range" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="set-a-grid-size-i.e-the-sampling-ratio-over-the-range"><span class="header-section-number">2.2</span> set a grid size, i.e the sampling ratio over the range</h3>
<p>In this case a rather small grid size of 7 is chosen. that means over the range of 0 to 1 we select 7 equaly spaced datapoints</p>
</section>
<section id="apply-the-grid-over-the-data" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="apply-the-grid-over-the-data"><span class="header-section-number">2.3</span> apply the grid over the data</h3>
<p>by utilizing the <code>np.linspace()</code> function we can easily create the grid, and create the required dataset with a cross join. for the people that know cross joins blow up your data pretty fast as it scales quadraticly. so our initial 3 datapoints together with the grid size increase the data count to $ 3 * 7 = 21 $ the newly created column is the feature for which we want to calculate the pd, in this case <code>x_0_sample</code></p>
<div id="cell-16" class="cell" data-execution_count="8">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>df_pdp <span class="op">=</span> df_sample.drop(columns<span class="op">=</span><span class="st">"x_0"</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>df_sample_grid <span class="op">=</span> pd.Series(np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">7</span>), name<span class="op">=</span><span class="st">"x_0_sample"</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a>df_pdp <span class="op">=</span> df_pdp.join(other<span class="op">=</span>df_sample_grid, how<span class="op">=</span><span class="st">"cross"</span>)</span>
<span id="cb9-4"><a href="#cb9-4"></a>df_pdp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x_1</th>
<th data-quarto-table-cell-role="th">x_2</th>
<th data-quarto-table-cell-role="th">x_3</th>
<th data-quarto-table-cell-role="th">x_4</th>
<th data-quarto-table-cell-role="th">x_5</th>
<th data-quarto-table-cell-role="th">x_6</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">x_0_sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.67</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.83</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.33</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.67</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.83</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>1.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.17</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.67</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.83</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>1.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="predict-with-the-model" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="predict-with-the-model"><span class="header-section-number">2.4</span> predict with the model</h3>
<p>for our new dataset we ask the model to make a prediction for each observations, so the original model is asked to create a predictions for each of the newly created 21 data points.</p>
<div id="cell-18" class="cell" data-execution_count="9">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>df_pdp <span class="op">=</span> df_pdp.assign(</span>
<span id="cb10-2"><a href="#cb10-2"></a>    y_pred<span class="op">=</span>reg.predict(</span>
<span id="cb10-3"><a href="#cb10-3"></a>        df_pdp.loc[</span>
<span id="cb10-4"><a href="#cb10-4"></a>            :, [<span class="st">"x_0_sample"</span>, <span class="st">"x_1"</span>, <span class="st">"x_2"</span>, <span class="st">"x_3"</span>, <span class="st">"x_4"</span>, <span class="st">"x_5"</span>, <span class="st">"x_6"</span>]</span>
<span id="cb10-5"><a href="#cb10-5"></a>        ].to_numpy()</span>
<span id="cb10-6"><a href="#cb10-6"></a>    )</span>
<span id="cb10-7"><a href="#cb10-7"></a>)</span>
<span id="cb10-8"><a href="#cb10-8"></a>df_pdp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x_1</th>
<th data-quarto-table-cell-role="th">x_2</th>
<th data-quarto-table-cell-role="th">x_3</th>
<th data-quarto-table-cell-role="th">x_4</th>
<th data-quarto-table-cell-role="th">x_5</th>
<th data-quarto-table-cell-role="th">x_6</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">x_0_sample</th>
<th data-quarto-table-cell-role="th">y_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.00</td>
<td>5.23</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.17</td>
<td>9.61</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.33</td>
<td>12.19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.50</td>
<td>12.58</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.67</td>
<td>12.72</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>0.83</td>
<td>12.66</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.70</td>
<td>0.83</td>
<td>0.03</td>
<td>0.26</td>
<td>0.53</td>
<td>0.61</td>
<td>12.79</td>
<td>1.00</td>
<td>12.79</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.00</td>
<td>5.76</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.17</td>
<td>9.31</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.33</td>
<td>9.89</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.50</td>
<td>11.27</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.67</td>
<td>11.67</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>0.83</td>
<td>11.60</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>0.70</td>
<td>0.38</td>
<td>0.02</td>
<td>0.38</td>
<td>0.40</td>
<td>0.14</td>
<td>8.29</td>
<td>1.00</td>
<td>11.86</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.00</td>
<td>6.65</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.17</td>
<td>6.97</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.33</td>
<td>7.73</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.50</td>
<td>9.19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.67</td>
<td>9.91</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>0.83</td>
<td>10.83</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>0.21</td>
<td>0.66</td>
<td>0.40</td>
<td>0.27</td>
<td>0.11</td>
<td>0.84</td>
<td>7.57</td>
<td>1.00</td>
<td>10.82</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="average-out-the-individual-predictions" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="average-out-the-individual-predictions"><span class="header-section-number">2.5</span> average out the individual predictions</h3>
<p>the next step is the aggregate the results by taking the average. this is achieved by taking the columns <code>x_0_sample</code> , <code>y_pred</code> and grouping by <code>x_0_sample</code> and applying mean aggregation.</p>
<div id="cell-20" class="cell" data-execution_count="10">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>df_pdp_plot <span class="op">=</span> (</span>
<span id="cb11-2"><a href="#cb11-2"></a>    df_pdp[[<span class="st">"x_0_sample"</span>, <span class="st">"y_pred"</span>]].groupby(<span class="st">"x_0_sample"</span>, as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb11-3"><a href="#cb11-3"></a>)</span>
<span id="cb11-4"><a href="#cb11-4"></a>df_pdp_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x_0_sample</th>
<th data-quarto-table-cell-role="th">y_pred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.00</td>
<td>5.88</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.17</td>
<td>8.63</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.33</td>
<td>9.94</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.50</td>
<td>11.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.67</td>
<td>11.43</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.83</td>
<td>11.70</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1.00</td>
<td>11.82</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>this is the dataframe that shows the average dependence of the target variable with respect to the feature <code>x_0</code> in this case. increasing the value of <code>x_0</code> also yields an increase of the target variable. as can be seen in the plot below. however keep in mind that this is done with a subset of the data on a very coarse grid. if more samples are included and the size of the grid is increased a more detailed dependence will emerge.</p>
<div id="cell-22" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>FIGSIZE)</span>
<span id="cb12-2"><a href="#cb12-2"></a>ax.plot(df_pdp_plot[<span class="st">"x_0_sample"</span>], df_pdp_plot[<span class="st">"y_pred"</span>])</span>
<span id="cb12-3"><a href="#cb12-3"></a>ax.set_xlabel(<span class="st">"$x_0$"</span>)</span>
<span id="cb12-4"><a href="#cb12-4"></a>ax.set_ylabel(<span class="st">"target"</span>)</span>
<span id="cb12-5"><a href="#cb12-5"></a>ax.set_title(<span class="st">"partial dependence of $x_0$ on the target variable"</span>)</span>
<span id="cb12-6"><a href="#cb12-6"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-12-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>the plot above shows that the response of the model is postive with respect to an increase in the value of feature <code>x_0</code> however this is done with just three datapoints,If we use the full dataset of 2000 samples and a sampling grid of 127 that would result in a final dataset of <span class="math inline">\(2000 * 128 = 256.000\)</span> samples. yikes that explodes fast and this is just for one feature. however we do have the ability to get a more accurate picture of the partial dependece of the <code>x_0</code> variable.</p>
<p>below you can see the code, i placed two comments to indicate where the changes have been made.</p>
<div id="cell-24" class="cell" data-execution_count="12">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>df_pdp <span class="op">=</span> df_reg.drop(columns<span class="op">=</span><span class="st">"x_0"</span>)  <span class="co"># &lt;- the full dataset</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>df_sample_grid <span class="op">=</span> pd.Series(</span>
<span id="cb13-3"><a href="#cb13-3"></a>    np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">128</span>),  <span class="co"># &lt;- sampling is 128</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>    name<span class="op">=</span><span class="st">"x_0_sample"</span>,</span>
<span id="cb13-5"><a href="#cb13-5"></a>)</span>
<span id="cb13-6"><a href="#cb13-6"></a>df_pdp <span class="op">=</span> df_pdp.join(other<span class="op">=</span>df_sample_grid, how<span class="op">=</span><span class="st">"cross"</span>)</span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a>df_pdp <span class="op">=</span> df_pdp.assign(</span>
<span id="cb13-9"><a href="#cb13-9"></a>    y_pred<span class="op">=</span>reg.predict(</span>
<span id="cb13-10"><a href="#cb13-10"></a>        df_pdp.loc[</span>
<span id="cb13-11"><a href="#cb13-11"></a>            :, [<span class="st">"x_0_sample"</span>, <span class="st">"x_1"</span>, <span class="st">"x_2"</span>, <span class="st">"x_3"</span>, <span class="st">"x_4"</span>, <span class="st">"x_5"</span>, <span class="st">"x_6"</span>]</span>
<span id="cb13-12"><a href="#cb13-12"></a>        ].to_numpy()</span>
<span id="cb13-13"><a href="#cb13-13"></a>    )</span>
<span id="cb13-14"><a href="#cb13-14"></a>)</span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a>df_pdp_plot_full <span class="op">=</span> (</span>
<span id="cb13-17"><a href="#cb13-17"></a>    df_pdp[[<span class="st">"x_0_sample"</span>, <span class="st">"y_pred"</span>]].groupby(<span class="st">"x_0_sample"</span>, as_index<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb13-18"><a href="#cb13-18"></a>)</span>
<span id="cb13-19"><a href="#cb13-19"></a></span>
<span id="cb13-20"><a href="#cb13-20"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>FIGSIZE)</span>
<span id="cb13-21"><a href="#cb13-21"></a>ax.plot(df_pdp_plot_full[<span class="st">"x_0_sample"</span>], df_pdp_plot_full[<span class="st">"y_pred"</span>])</span>
<span id="cb13-22"><a href="#cb13-22"></a>ax.set_xlabel(<span class="st">"$x_0$"</span>)</span>
<span id="cb13-23"><a href="#cb13-23"></a>ax.set_ylabel(<span class="st">"target"</span>)</span>
<span id="cb13-24"><a href="#cb13-24"></a>ax.set_title(<span class="st">"partial dependence of $x_0$ on the target variable"</span>)</span>
<span id="cb13-25"><a href="#cb13-25"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-13-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>the same picture as before emerges however this time it includes a little more detail, an increaase in <code>x_0</code> also yields an increase in the target variable to an almost monotonic level.</p>
</section>
</section>
<section id="scikit-learn-implementation" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="scikit-learn-implementation"><span class="header-section-number">3</span> Scikit-learn implementation</h2>
<p>in practise we would not code our own PDP routinge but first look if there already is a lib that does the job and scikit-learn has an implementation of a <a href="https://scikit-learn.org/stable/modules/generated/sklearn.inspection.partial_dependence.html#sklearn.inspection.partial_dependence">partial dependence</a> and also the <a href="https://shap.readthedocs.io/en/latest/generated/shap.plots.partial_dependence.html">SHAP</a> packages has a PDP option, super handy if you are already using it to get shapley values.</p>
<section id="one-way-partial-dependence" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="one-way-partial-dependence"><span class="header-section-number">3.1</span> one-way partial dependence</h3>
<p>by using the scikit-learn function we can easily create plots for our entire dataset. it is just with a one-liner ðŸ˜Š.</p>
<div id="cell-29" class="cell" data-execution_count="13">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">16</span>))</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>PartialDependenceDisplay.from_estimator(</span>
<span id="cb14-4"><a href="#cb14-4"></a>    estimator<span class="op">=</span>reg, X<span class="op">=</span>X, features<span class="op">=</span><span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">7</span>), grid_resolution<span class="op">=</span><span class="dv">128</span>, kind<span class="op">=</span><span class="st">"average"</span>, ax<span class="op">=</span>ax</span>
<span id="cb14-5"><a href="#cb14-5"></a>)</span>
<span id="cb14-6"><a href="#cb14-6"></a>plt.tight_layout()</span>
<span id="cb14-7"><a href="#cb14-7"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-14-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>for the plot above we can clearly see that <code>x_6</code> and <code>x_5</code> do not meaningfully contribute to the output of the model. so changes one of those two will not change the predicted target value. this is also logical because these two features are random noise. <code>x_2</code> has the shape of a bathtub and the mean of 0.5 yields the lowest target outcome. <code>x_0</code> and <code>x_1</code> show a steady monotonic increase and plateau for the higher input values, after which the impact on the target is diminished. for the remaining two features <code>x_3</code> and <code>x_4</code> show that an increase in the feature yields a higher outcome of the target, also a big jump in output can be seen at around 0.4 for <code>x_3</code> adn 0.6 for <code>x_4</code></p>
</section>
<section id="two-way-partial-dependence" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="two-way-partial-dependence"><span class="header-section-number">3.2</span> two-way partial dependence</h3>
<p>It is possible to adapt this approach and get the PDP of two features with respect to the target variable. the trick is to create a sample grid that is the product of the two features. but again this will increase the number of datapoints that need to be inferenced. however now you can obtain insights into the feature interactions and the results it has on the target variable.</p>
<div id="cell-32" class="cell" data-execution_count="14">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>FIGSIZE)</span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a>PartialDependenceDisplay.from_estimator(</span>
<span id="cb15-4"><a href="#cb15-4"></a>    reg, X, features<span class="op">=</span>[(<span class="dv">1</span>, <span class="dv">2</span>)], grid_resolution<span class="op">=</span><span class="dv">128</span>, ax<span class="op">=</span>ax</span>
<span id="cb15-5"><a href="#cb15-5"></a>)</span>
<span id="cb15-6"><a href="#cb15-6"></a>plt.tight_layout()</span>
<span id="cb15-7"><a href="#cb15-7"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-15-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="bonus-individual-conditional-expectation" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="bonus-individual-conditional-expectation"><span class="header-section-number">4</span> Bonus: Individual Conditional Expectation</h2>
<p>instead of performing a aggregation and plotting the result, theinndividual observations can alos be used. in the plot each blue line is an original observation were the value of <code>x_3</code> has taken over by the sampling grid. this allows you to inspect the individual datapoints. in this case we have a well beheaved dataset were all points are in agreement however this plot might give you some insights if performance is lacking for a couple of datapoints. it well may be that if the feature values is increased the target value goes up for one group and goes down for another group.</p>
<div id="cell-34" class="cell" data-execution_count="15">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">9</span>))</span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a>idx <span class="op">=</span> np.random.randint(<span class="bu">len</span>(X), size<span class="op">=</span><span class="bu">int</span>(<span class="bu">len</span>(X) <span class="op">*</span> <span class="fl">0.1</span>), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a></span>
<span id="cb16-6"><a href="#cb16-6"></a>PartialDependenceDisplay.from_estimator(</span>
<span id="cb16-7"><a href="#cb16-7"></a>    reg, X.loc[idx, :], features<span class="op">=</span>[<span class="dv">3</span>], kind<span class="op">=</span><span class="st">"both"</span>, grid_resolution<span class="op">=</span><span class="dv">128</span>, ax<span class="op">=</span>ax</span>
<span id="cb16-8"><a href="#cb16-8"></a>)</span>
<span id="cb16-9"><a href="#cb16-9"></a>ax.set_title(<span class="st">"Individual Condition Expectation"</span>)</span>
<span id="cb16-10"><a href="#cb16-10"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-16-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-36" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">### gif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-37" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="im">import</span> gif  <span class="co"># noqa E402</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-38" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>idx <span class="op">=</span> np.random.randint(<span class="bu">len</span>(X), size<span class="op">=</span><span class="bu">int</span>(<span class="bu">len</span>(X) <span class="op">*</span> <span class="fl">0.025</span>), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>pdp_results <span class="op">=</span> partial_dependence(</span>
<span id="cb19-5"><a href="#cb19-5"></a>    estimator<span class="op">=</span>reg,</span>
<span id="cb19-6"><a href="#cb19-6"></a>    X<span class="op">=</span>X.loc[idx, :],</span>
<span id="cb19-7"><a href="#cb19-7"></a>    features<span class="op">=</span>[<span class="st">"x_3"</span>],</span>
<span id="cb19-8"><a href="#cb19-8"></a>    grid_resolution<span class="op">=</span><span class="dv">33</span>,</span>
<span id="cb19-9"><a href="#cb19-9"></a>    kind<span class="op">=</span><span class="st">"both"</span>,</span>
<span id="cb19-10"><a href="#cb19-10"></a>)</span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12"><a href="#cb19-12"></a>plt.plot(</span>
<span id="cb19-13"><a href="#cb19-13"></a>    pdp_results[<span class="st">"individual"</span>][<span class="dv">0</span>].T,</span>
<span id="cb19-14"><a href="#cb19-14"></a>    linestyle<span class="op">=</span><span class="st">"-"</span>,</span>
<span id="cb19-15"><a href="#cb19-15"></a>    linewidth<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb19-16"><a href="#cb19-16"></a>    alpha<span class="op">=</span><span class="fl">0.33</span>,</span>
<span id="cb19-17"><a href="#cb19-17"></a>    color<span class="op">=</span><span class="st">"tab:blue"</span>,</span>
<span id="cb19-18"><a href="#cb19-18"></a>)</span>
<span id="cb19-19"><a href="#cb19-19"></a>plt.plot(</span>
<span id="cb19-20"><a href="#cb19-20"></a>    np.mean(pdp_results[<span class="st">"individual"</span>][<span class="dv">0</span>].T, axis<span class="op">=</span><span class="dv">1</span>), linestyle<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"tab:orange"</span></span>
<span id="cb19-21"><a href="#cb19-21"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-20-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-39" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>individual_lines <span class="op">=</span> pdp_results[<span class="st">"individual"</span>][<span class="dv">0</span>].T</span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a></span>
<span id="cb20-4"><a href="#cb20-4"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>FIGSIZE)</span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a>ax.plot(</span>
<span id="cb20-8"><a href="#cb20-8"></a>    pdp_results[<span class="st">"grid_values"</span>][<span class="dv">0</span>],</span>
<span id="cb20-9"><a href="#cb20-9"></a>    individual_lines[:, <span class="dv">0</span>],</span>
<span id="cb20-10"><a href="#cb20-10"></a>    linestyle<span class="op">=</span><span class="st">"-"</span>,</span>
<span id="cb20-11"><a href="#cb20-11"></a>    linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb20-12"><a href="#cb20-12"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb20-13"><a href="#cb20-13"></a>    color<span class="op">=</span><span class="st">"tab:blue"</span>,</span>
<span id="cb20-14"><a href="#cb20-14"></a>)</span>
<span id="cb20-15"><a href="#cb20-15"></a></span>
<span id="cb20-16"><a href="#cb20-16"></a></span>
<span id="cb20-17"><a href="#cb20-17"></a>xlim_begin, ylim_begin <span class="op">=</span> ax.get_xlim(), ax.get_ylim()</span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a></span>
<span id="cb20-20"><a href="#cb20-20"></a>ax.plot(</span>
<span id="cb20-21"><a href="#cb20-21"></a>    pdp_results[<span class="st">"grid_values"</span>][<span class="dv">0</span>],</span>
<span id="cb20-22"><a href="#cb20-22"></a>    individual_lines[:, :],</span>
<span id="cb20-23"><a href="#cb20-23"></a>    linestyle<span class="op">=</span><span class="st">"-"</span>,</span>
<span id="cb20-24"><a href="#cb20-24"></a>    linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb20-25"><a href="#cb20-25"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb20-26"><a href="#cb20-26"></a>    color<span class="op">=</span><span class="st">"tab:blue"</span>,</span>
<span id="cb20-27"><a href="#cb20-27"></a>)</span>
<span id="cb20-28"><a href="#cb20-28"></a></span>
<span id="cb20-29"><a href="#cb20-29"></a>xlim_end, ylim_end <span class="op">=</span> ax.get_xlim(), ax.get_ylim()</span>
<span id="cb20-30"><a href="#cb20-30"></a></span>
<span id="cb20-31"><a href="#cb20-31"></a>zoom_factor <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-32"><a href="#cb20-32"></a><span class="co"># get the global axes limits</span></span>
<span id="cb20-33"><a href="#cb20-33"></a>overal_xlim <span class="op">=</span> (</span>
<span id="cb20-34"><a href="#cb20-34"></a>    <span class="bu">min</span>(xlim_begin[<span class="dv">0</span>], xlim_end[<span class="dv">0</span>]) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> zoom_factor),</span>
<span id="cb20-35"><a href="#cb20-35"></a>    <span class="bu">max</span>(xlim_begin[<span class="dv">1</span>], xlim_end[<span class="dv">1</span>]) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> zoom_factor),</span>
<span id="cb20-36"><a href="#cb20-36"></a>)</span>
<span id="cb20-37"><a href="#cb20-37"></a>overal_ylim <span class="op">=</span> (</span>
<span id="cb20-38"><a href="#cb20-38"></a>    <span class="bu">min</span>(ylim_begin[<span class="dv">0</span>], ylim_end[<span class="dv">0</span>]) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> zoom_factor),</span>
<span id="cb20-39"><a href="#cb20-39"></a>    <span class="bu">max</span>(ylim_begin[<span class="dv">1</span>], ylim_end[<span class="dv">1</span>]) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> zoom_factor),</span>
<span id="cb20-40"><a href="#cb20-40"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="dependency_files/figure-html/cell-21-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-40" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># for i in range(individual_lines.shape[1])</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="at">@gif.frame</span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="kw">def</span> one_frame(i: <span class="bu">int</span>, overal_xlim<span class="op">=</span><span class="va">None</span>, overal_ylim<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb21-6"><a href="#cb21-6"></a>    _, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>FIGSIZE)</span>
<span id="cb21-7"><a href="#cb21-7"></a></span>
<span id="cb21-8"><a href="#cb21-8"></a>    ax.plot(</span>
<span id="cb21-9"><a href="#cb21-9"></a>        pdp_results[<span class="st">"grid_values"</span>][<span class="dv">0</span>],</span>
<span id="cb21-10"><a href="#cb21-10"></a>        individual_lines[:, :i],</span>
<span id="cb21-11"><a href="#cb21-11"></a>        linestyle<span class="op">=</span><span class="st">"-"</span>,</span>
<span id="cb21-12"><a href="#cb21-12"></a>        linewidth<span class="op">=</span><span class="fl">0.75</span>,</span>
<span id="cb21-13"><a href="#cb21-13"></a>        alpha<span class="op">=</span><span class="fl">0.35</span>,</span>
<span id="cb21-14"><a href="#cb21-14"></a>        color<span class="op">=</span><span class="st">"tab:blue"</span>,</span>
<span id="cb21-15"><a href="#cb21-15"></a>    )</span>
<span id="cb21-16"><a href="#cb21-16"></a></span>
<span id="cb21-17"><a href="#cb21-17"></a>    <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb21-18"><a href="#cb21-18"></a>        ax.plot(</span>
<span id="cb21-19"><a href="#cb21-19"></a>            pdp_results[<span class="st">"grid_values"</span>][<span class="dv">0</span>],</span>
<span id="cb21-20"><a href="#cb21-20"></a>            np.mean(individual_lines[:, :i], axis<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb21-21"><a href="#cb21-21"></a>            linestyle<span class="op">=</span><span class="st">"--"</span>,</span>
<span id="cb21-22"><a href="#cb21-22"></a>            linewidth<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb21-23"><a href="#cb21-23"></a>            color<span class="op">=</span><span class="st">"tab:orange"</span>,</span>
<span id="cb21-24"><a href="#cb21-24"></a>        )</span>
<span id="cb21-25"><a href="#cb21-25"></a></span>
<span id="cb21-26"><a href="#cb21-26"></a>    <span class="co"># set the overal axes</span></span>
<span id="cb21-27"><a href="#cb21-27"></a>    ax.set_xlim(overal_xlim), ax.set_ylim(overal_ylim)</span>
<span id="cb21-28"><a href="#cb21-28"></a></span>
<span id="cb21-29"><a href="#cb21-29"></a>    <span class="co"># remove the ticks and lables from the axes</span></span>
<span id="cb21-30"><a href="#cb21-30"></a>    xticks <span class="op">=</span> ax.get_xticks()</span>
<span id="cb21-31"><a href="#cb21-31"></a>    ax.set_xticks(xticks, labels<span class="op">=</span>[])</span>
<span id="cb21-32"><a href="#cb21-32"></a>    ax.set_xlabel(<span class="st">""</span>)</span>
<span id="cb21-33"><a href="#cb21-33"></a></span>
<span id="cb21-34"><a href="#cb21-34"></a>    yticks <span class="op">=</span> ax.get_yticks()</span>
<span id="cb21-35"><a href="#cb21-35"></a>    ax.set_yticks(yticks, labels<span class="op">=</span>[])</span>
<span id="cb21-36"><a href="#cb21-36"></a>    ax.set_ylabel(<span class="st">""</span>)</span>
<span id="cb21-37"><a href="#cb21-37"></a></span>
<span id="cb21-38"><a href="#cb21-38"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-41" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># genearate all base frames</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>gif_frames <span class="op">=</span> [</span>
<span id="cb22-3"><a href="#cb22-3"></a>    one_frame(i, overal_xlim, overal_ylim) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(individual_lines.shape[<span class="dv">1</span>])</span>
<span id="cb22-4"><a href="#cb22-4"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-42" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># add bounce and freeze point</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>gif_frames.extend([gif_frames[<span class="op">-</span><span class="dv">1</span>] <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">60</span>)])</span>
<span id="cb23-3"><a href="#cb23-3"></a>gif_frames.extend(gif_frames[::<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-43" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>gif.save(gif_frames, <span class="st">"artifacts/ice_lines.gif"</span>, duration<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jope35\.github\.io\/hypershotgun-blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>