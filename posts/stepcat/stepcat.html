<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joost de Theije + LLM">
<meta name="dcterms.date" content="2024-03-14">

<title>hyper-shotgun - some points are more or less random than others</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicons/hyper_favi.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../apple-touch-icon.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">hyper-shotgun</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../whois.html"> 
<span class="menu-text">whois 🤖</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/joostdetheije/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text">LinkedIn</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/jope35"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">Github</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">some points are more or less random than others</h1>
            <p class="subtitle lead">stepwise tuning of gradient boosting models</p>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Joost de Theije + LLM </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 14, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      i am an abstract piece of arts
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#intro" id="toc-intro" class="nav-link active" data-scroll-target="#intro"><span class="header-section-number">1</span> Intro</a>
  <ul class="collapse">
  <li><a href="#gridsearch" id="toc-gridsearch" class="nav-link" data-scroll-target="#gridsearch"><span class="header-section-number">1.1</span> GridSearch</a></li>
  <li><a href="#randomsearch" id="toc-randomsearch" class="nav-link" data-scroll-target="#randomsearch"><span class="header-section-number">1.2</span> RandomSearch</a></li>
  <li><a href="#something-in-between" id="toc-something-in-between" class="nav-link" data-scroll-target="#something-in-between"><span class="header-section-number">1.3</span> Something in between</a></li>
  <li><a href="#visual-represantation" id="toc-visual-represantation" class="nav-link" data-scroll-target="#visual-represantation"><span class="header-section-number">1.4</span> visual represantation</a></li>
  </ul></li>
  <li><a href="#apply-lhs-to-a-real-application" id="toc-apply-lhs-to-a-real-application" class="nav-link" data-scroll-target="#apply-lhs-to-a-real-application"><span class="header-section-number">2</span> apply lhs to a real application</a>
  <ul class="collapse">
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">2.1</span> dataset</a></li>
  <li><a href="#info-on-dataset" id="toc-info-on-dataset" class="nav-link" data-scroll-target="#info-on-dataset"><span class="header-section-number">2.2</span> info on dataset</a></li>
  <li><a href="#creating-data-pools" id="toc-creating-data-pools" class="nav-link" data-scroll-target="#creating-data-pools"><span class="header-section-number">2.3</span> creating data pools</a></li>
  <li><a href="#applying-three-sampling-techniques-grid-random-and-lhs" id="toc-applying-three-sampling-techniques-grid-random-and-lhs" class="nav-link" data-scroll-target="#applying-three-sampling-techniques-grid-random-and-lhs"><span class="header-section-number">2.4</span> Applying Three Sampling Techniques: Grid, Random, and LHS</a></li>
  <li><a href="#grid-search" id="toc-grid-search" class="nav-link" data-scroll-target="#grid-search"><span class="header-section-number">2.5</span> grid search</a></li>
  <li><a href="#random-search" id="toc-random-search" class="nav-link" data-scroll-target="#random-search"><span class="header-section-number">2.6</span> Random search</a></li>
  <li><a href="#lhs-search" id="toc-lhs-search" class="nav-link" data-scroll-target="#lhs-search"><span class="header-section-number">2.7</span> LHS search</a></li>
  <li><a href="#compare-the-three-results" id="toc-compare-the-three-results" class="nav-link" data-scroll-target="#compare-the-three-results"><span class="header-section-number">2.8</span> compare the three results</a></li>
  </ul></li>
  <li><a href="#bonus-optuna-hyperparameter-optimization-framework" id="toc-bonus-optuna-hyperparameter-optimization-framework" class="nav-link" data-scroll-target="#bonus-optuna-hyperparameter-optimization-framework"><span class="header-section-number">3</span> Bonus: Optuna hyperparameter optimization framework</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div id="cell-1" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> time</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> warnings</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="im">import</span> optuna</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">from</span> catboost <span class="im">import</span> CatBoostClassifier, Pool</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="im">from</span> matplotlib_inline.backend_inline <span class="im">import</span> set_matplotlib_formats</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">from</span> scipy.stats <span class="im">import</span> qmc</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> fetch_openml</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> ParameterGrid, train_test_split</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tqdm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-2" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>set_matplotlib_formats(<span class="st">"svg"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a>sns.set_style(<span class="st">"darkgrid"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>sns.set_context(<span class="st">"paper"</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a>sns.set_context(context<span class="op">=</span><span class="st">"notebook"</span>, font_scale<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb2-8"><a href="#cb2-8"></a>FIGSIZE <span class="op">=</span> (<span class="dv">12</span>, <span class="dv">6</span>)</span>
<span id="cb2-9"><a href="#cb2-9"></a>N_SAMPLES <span class="op">=</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="intro" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Intro</h1>
<p>We have all encountered this predicament. The moment when we believe our features are satisfactory, and we’re ready to train our first model. Initially, we begin with the default settings of the model, which yields acceptable performance. However, to achieve superior results, we determine that hyperparameter tuning is necessary. Referring to the documentation of <a href="https://scikit-learn.org/stable/modules/classes.html#module-model_selection">Scikit-Learn</a>, there are several options: GridSearchCV and RandomizedSearchCV are the most common choices.</p>
<section id="gridsearch" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="gridsearch"><span class="header-section-number">1.1</span> GridSearch</h2>
<p>GridSearchCV is a hyperparameter tuning method in Scikit-Learn that uses exhaustive search to find the best combination of estimator parameters. It tries all possible combinations of specified parameter values using cross-validation to evaluate each set. Pros include exhaustive exploration and handling various methods, providing detailed performance information. However, it is time-consuming and memory-intensive, as it tests all combinations. The choice of cross-validation method and number of folds significantly impacts results.</p>
</section>
<section id="randomsearch" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="randomsearch"><span class="header-section-number">1.2</span> RandomSearch</h2>
<p>RandomizedSearchCV is a hyperparameter tuning method in Scikit-Learn that uses random sampling to search for the best combination of estimator parameters. Unlike GridSearchCV, which tries all possible combinations, it samples a fixed number of parameter settings from specified distributions. It is more efficient than exhaustive search but may not find the absolute best set of parameters. Cross-validation is used to evaluate each sampled set, and continuous or categorical distributions can be specified. The choice of distributions and iterations impacts results, as well as the cross-validation method and number of folds.</p>
</section>
<section id="something-in-between" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="something-in-between"><span class="header-section-number">1.3</span> Something in between</h2>
<p>There are techniques called Latin Hypercube Sampling (LHS) or Poisson Discs sampling that mix grid and random sampling together.</p>
<p>Latin Hypercube Sampling is a deterministic, space-filling design technique that selects a representative sample from the parameter space by ensuring that every hyperrectangle enclosing each unique combination of parameters contains at least one sample. In simpler terms, LHS aims to provide a representative and uniform distribution of samples across the entire range of possible combinations.</p>
<p>Consider the analogy of a Sudoku puzzle. Each square on the board represents a unique combination of parameters. While you may be tempted to reveal all the numbers in one row or column, this would be an unwise move as it would limit the overall usefulness of your picks. LHS offers a framework for reducing the number of picks while maximizing their effectiveness, if you have selected a square from one row it would favor other rows more, the same logic applies to the columns and sub-squares.</p>
<p><img src="artifacts/sudoku.png" class="img-fluid"></p>
<p>In conclusion, when choosing between hyperparameter tuning methods, it is essential to consider factors like computational resources, time constraints, and the complexity of the problem at hand. GridSearchCV provides exhaustive exploration but comes with higher computational costs, while RandomizedSearchCV offers flexibility and efficiency but may not find the absolute best combination of parameters. Latin Hypercube Sampling sampling offer a balance between these two extremes by providing representative samples while being more computationally efficient than GridSearchCV for large search spaces.</p>
</section>
<section id="visual-represantation" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="visual-represantation"><span class="header-section-number">1.4</span> visual represantation</h2>
<p>To illustrate the distinction between the three sampling methods, let’s consider a hypothetical scenario in a two-dimensional space, spanning from 0 to 1 inclusively and apply the three sampling strategies random, lhs, and grid.</p>
<div id="cell-8" class="cell" data-execution_count="5">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>uni_sample <span class="op">=</span> np.random.uniform(<span class="dv">0</span>, <span class="dv">1</span>, (<span class="dv">100</span>, <span class="dv">2</span>))</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>sampler <span class="op">=</span> qmc.LatinHypercube(d<span class="op">=</span><span class="dv">2</span>, optimization<span class="op">=</span><span class="st">"lloyd"</span>)</span>
<span id="cb3-6"><a href="#cb3-6"></a>lhs_sample <span class="op">=</span> sampler.random(n<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a>grid_sample <span class="op">=</span> np.array(</span>
<span id="cb3-9"><a href="#cb3-9"></a>    [[i, j] <span class="cf">for</span> i <span class="kw">in</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>) <span class="cf">for</span> j <span class="kw">in</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>)]</span>
<span id="cb3-10"><a href="#cb3-10"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-9" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>_, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a>curr_ax <span class="op">=</span> ax[<span class="dv">0</span>]</span>
<span id="cb4-5"><a href="#cb4-5"></a>sns.histplot(</span>
<span id="cb4-6"><a href="#cb4-6"></a>    x<span class="op">=</span>uni_sample[:, <span class="dv">0</span>], y<span class="op">=</span>uni_sample[:, <span class="dv">1</span>], bins<span class="op">=</span><span class="dv">10</span>, ax<span class="op">=</span>curr_ax, cbar<span class="op">=</span><span class="va">True</span>, thresh<span class="op">=</span><span class="va">None</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>)</span>
<span id="cb4-8"><a href="#cb4-8"></a>sns.scatterplot(x<span class="op">=</span>uni_sample[:, <span class="dv">0</span>], y<span class="op">=</span>uni_sample[:, <span class="dv">1</span>], ax<span class="op">=</span>curr_ax, color<span class="op">=</span><span class="st">"tab:orange"</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a>curr_ax.set_xticks([])</span>
<span id="cb4-10"><a href="#cb4-10"></a>curr_ax.set_yticks([])</span>
<span id="cb4-11"><a href="#cb4-11"></a>curr_ax.set_title(<span class="st">"uniform sampling"</span>)</span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a>curr_ax <span class="op">=</span> ax[<span class="dv">1</span>]</span>
<span id="cb4-15"><a href="#cb4-15"></a>sns.histplot(</span>
<span id="cb4-16"><a href="#cb4-16"></a>    x<span class="op">=</span>lhs_sample[:, <span class="dv">0</span>], y<span class="op">=</span>lhs_sample[:, <span class="dv">1</span>], bins<span class="op">=</span><span class="dv">10</span>, ax<span class="op">=</span>curr_ax, cbar<span class="op">=</span><span class="va">True</span>, thresh<span class="op">=</span><span class="va">None</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>)</span>
<span id="cb4-18"><a href="#cb4-18"></a>sns.scatterplot(x<span class="op">=</span>lhs_sample[:, <span class="dv">0</span>], y<span class="op">=</span>lhs_sample[:, <span class="dv">1</span>], ax<span class="op">=</span>curr_ax, color<span class="op">=</span><span class="st">"tab:orange"</span>)</span>
<span id="cb4-19"><a href="#cb4-19"></a>curr_ax.set_xticks([])</span>
<span id="cb4-20"><a href="#cb4-20"></a>curr_ax.set_yticks([])</span>
<span id="cb4-21"><a href="#cb4-21"></a>curr_ax.set_title(<span class="st">"latin hypercube sampling"</span>)</span>
<span id="cb4-22"><a href="#cb4-22"></a></span>
<span id="cb4-23"><a href="#cb4-23"></a></span>
<span id="cb4-24"><a href="#cb4-24"></a>curr_ax <span class="op">=</span> ax[<span class="dv">2</span>]</span>
<span id="cb4-25"><a href="#cb4-25"></a>sns.histplot(</span>
<span id="cb4-26"><a href="#cb4-26"></a>    x<span class="op">=</span>grid_sample[:, <span class="dv">0</span>],</span>
<span id="cb4-27"><a href="#cb4-27"></a>    y<span class="op">=</span>grid_sample[:, <span class="dv">1</span>],</span>
<span id="cb4-28"><a href="#cb4-28"></a>    bins<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb4-29"><a href="#cb4-29"></a>    ax<span class="op">=</span>curr_ax,</span>
<span id="cb4-30"><a href="#cb4-30"></a>    cbar<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-31"><a href="#cb4-31"></a>    thresh<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb4-32"><a href="#cb4-32"></a>)</span>
<span id="cb4-33"><a href="#cb4-33"></a>sns.scatterplot(</span>
<span id="cb4-34"><a href="#cb4-34"></a>    x<span class="op">=</span>grid_sample[:, <span class="dv">0</span>], y<span class="op">=</span>grid_sample[:, <span class="dv">1</span>], ax<span class="op">=</span>curr_ax, color<span class="op">=</span><span class="st">"tab:orange"</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>)</span>
<span id="cb4-36"><a href="#cb4-36"></a>curr_ax.set_xticks([])</span>
<span id="cb4-37"><a href="#cb4-37"></a>curr_ax.set_yticks([])</span>
<span id="cb4-38"><a href="#cb4-38"></a>curr_ax.set_title(<span class="st">"grid sampling"</span>)</span>
<span id="cb4-39"><a href="#cb4-39"></a></span>
<span id="cb4-40"><a href="#cb4-40"></a>plt.tight_layout()</span>
<span id="cb4-41"><a href="#cb4-41"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="stepcat_files/figure-html/cell-5-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="apply-lhs-to-a-real-application" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> apply lhs to a real application</h1>
<p>Lets put this knowledge into pratice by performing some hyper-parameter tuning of a catboost model on a <a href="https://www.openml.org/search?type=data&amp;status=active&amp;id=1461">dataset</a></p>
<p>The dataset is about direct marketing campaigns of a Portuguese banking institution, focusing on phone calls to promote term deposits. The data includes 17 input variables and one output variable. Input attributes consist of client demographics such as age, job type, marital status, education level, credit default status, average yearly balance, housing loan status, personal loan status, contact communication type, last contact day and month, duration of contact, number of contacts during the current campaign, number of days since last contact from a previous campaign, number of contacts before the current campaign, and the outcome of the previous marketing campaign. The goal is to predict if a client will subscribe to a term deposit based on these features.</p>
<p>This dataset is a binary classification problem where the goal is to predict if a client will subscribe to a term deposit based on multiple categorical and numerical features, making it an excellent use case for CatBoost, a gradient boosting library specifically designed to handle categorical data.</p>
<section id="dataset" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="dataset"><span class="header-section-number">2.1</span> dataset</h2>
<p>We can utilize the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.fetch_openml.html#sklearn.datasets.fetch_openml"><code>fetch_openml</code></a> function from scikit-learn to automatically fetch the appropriate dataset. Following this, the data will be split into train and test sets with stratification controlled on the target variable. That is, the distribution of the target variable (y) is maintained equal for both the training and testing sets.</p>
<div id="cell-12" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># fetch data set</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>ID <span class="op">=</span> <span class="dv">1461</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>X, y <span class="op">=</span> fetch_openml(</span>
<span id="cb5-4"><a href="#cb5-4"></a>    data_id<span class="op">=</span>ID,</span>
<span id="cb5-5"><a href="#cb5-5"></a>    data_home<span class="op">=</span><span class="ss">f"openml_download_</span><span class="sc">{</span>ID<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>    return_X_y<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>)</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># downsample and create a stratified train test split</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>X <span class="op">=</span> X.sample(frac<span class="op">=</span><span class="fl">0.25</span>)  <span class="co"># control the size of the dataset</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>X <span class="op">=</span> X.dropna(axis<span class="op">=</span><span class="dv">0</span>, how<span class="op">=</span><span class="st">"any"</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co"># y = y.astype(int) - 1</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>y <span class="op">=</span> y.loc[X.index]  <span class="co"># align the datasets</span></span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb5-17"><a href="#cb5-17"></a>    X,</span>
<span id="cb5-18"><a href="#cb5-18"></a>    y,</span>
<span id="cb5-19"><a href="#cb5-19"></a>    test_size<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb5-20"><a href="#cb5-20"></a>    stratify<span class="op">=</span>y,</span>
<span id="cb5-21"><a href="#cb5-21"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="info-on-dataset" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="info-on-dataset"><span class="header-section-number">2.2</span> info on dataset</h2>
<p>As mentioned earlier, the dataset comprises 9 categorical and 7 numerical features. This configuration makes the dataset well-suited for using CatBoost. CatBoost employs a specialized technique called “ordered target encoding” that converts categorical features into numerical values, rendering them amenable to gradient boosting models. This approach can result in enhanced model performance and accuracy compared to other machine learning algorithms, particularly when managing datasets replete with a substantial number of categorical features.</p>
<div id="cell-14" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>X.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="creating-data-pools" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="creating-data-pools"><span class="header-section-number">2.3</span> creating data pools</h2>
<p>CatBoost provides an option to create pools of data. This feature allows CatBoost to optimize the handling of large files internally. In this specific case, defining categorical features in one place and being able to reuse them later is a benefit for improving reproducibility.</p>
<div id="cell-16" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>train_pool <span class="op">=</span> Pool(</span>
<span id="cb7-2"><a href="#cb7-2"></a>    data<span class="op">=</span>X_train,</span>
<span id="cb7-3"><a href="#cb7-3"></a>    label<span class="op">=</span>y_train,</span>
<span id="cb7-4"><a href="#cb7-4"></a>    cat_features<span class="op">=</span><span class="bu">list</span>(X.select_dtypes(include<span class="op">=</span><span class="st">"category"</span>).columns),</span>
<span id="cb7-5"><a href="#cb7-5"></a>)</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a>test_pool <span class="op">=</span> Pool(</span>
<span id="cb7-8"><a href="#cb7-8"></a>    data<span class="op">=</span>X_test,</span>
<span id="cb7-9"><a href="#cb7-9"></a>    label<span class="op">=</span>y_test,</span>
<span id="cb7-10"><a href="#cb7-10"></a>    cat_features<span class="op">=</span><span class="bu">list</span>(X.select_dtypes(include<span class="op">=</span><span class="st">"category"</span>).columns),</span>
<span id="cb7-11"><a href="#cb7-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="applying-three-sampling-techniques-grid-random-and-lhs" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="applying-three-sampling-techniques-grid-random-and-lhs"><span class="header-section-number">2.4</span> Applying Three Sampling Techniques: Grid, Random, and LHS</h2>
<p>In the following section, we apply and compare the results of the three sampling techniques: grid search, random search, and Latin Hypercube Sampling (LHS). The objective is to demonstrate that LHS explores more of the design space than random search while maintaining enough randomness to mitigate the symmetry issues inherent in grid search.</p>
<p>The search space is defined by the following parameters.</p>
<ul>
<li>depth <span class="math inline">\([1 \dotsc 15]\)</span></li>
<li>iterations <span class="math inline">\([1 \dotsc 1024]\)</span></li>
<li>subsample <span class="math inline">\([0.1,1]\)</span></li>
<li>bagging_temperatur <span class="math inline">\([1 \dotsc 1e6]\)</span></li>
</ul>
<p>The number of samples used is 100.</p>
</section>
<section id="grid-search" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="grid-search"><span class="header-section-number">2.5</span> grid search</h2>
<p>To adhere to the limit of 100 samples, we use <span class="math inline">\(100^{1/4}\approx 3\)</span> this results in <span class="math inline">\(3^4=81\)</span> samples.</p>
<div id="cell-19" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>n_grid_samples <span class="op">=</span> np.power(N_SAMPLES, <span class="dv">1</span> <span class="op">/</span> <span class="dv">4</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a>n_grid_samples <span class="op">=</span> np.floor(n_grid_samples).astype(<span class="bu">int</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>param_grid <span class="op">=</span> {</span>
<span id="cb8-5"><a href="#cb8-5"></a>    <span class="st">"depth"</span>: np.linspace(<span class="dv">1</span>, <span class="dv">15</span>, n_grid_samples, dtype<span class="op">=</span><span class="bu">int</span>),</span>
<span id="cb8-6"><a href="#cb8-6"></a>    <span class="st">"iterations"</span>: np.linspace(<span class="dv">1</span>, <span class="dv">1024</span>, n_grid_samples, dtype<span class="op">=</span><span class="bu">int</span>),</span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="st">"subsample"</span>: np.linspace(<span class="fl">0.1</span>, <span class="dv">1</span>, n_grid_samples, endpoint<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb8-8"><a href="#cb8-8"></a>    <span class="st">"bagging_temperature"</span>: np.linspace(<span class="dv">1</span>, <span class="dv">1000000</span>, n_grid_samples, dtype<span class="op">=</span><span class="bu">int</span>),</span>
<span id="cb8-9"><a href="#cb8-9"></a>}</span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a>param_combo <span class="op">=</span> <span class="bu">list</span>(ParameterGrid(param_grid<span class="op">=</span>param_grid))</span>
<span id="cb8-12"><a href="#cb8-12"></a></span>
<span id="cb8-13"><a href="#cb8-13"></a>cube_search <span class="op">=</span> []</span>
<span id="cb8-14"><a href="#cb8-14"></a>start <span class="op">=</span> time.time()</span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="cf">for</span> param <span class="kw">in</span> tqdm(param_combo):</span>
<span id="cb8-16"><a href="#cb8-16"></a>    cbc <span class="op">=</span> CatBoostClassifier(</span>
<span id="cb8-17"><a href="#cb8-17"></a>        <span class="op">**</span>param,</span>
<span id="cb8-18"><a href="#cb8-18"></a>        eval_metric<span class="op">=</span><span class="st">"F1"</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>    )</span>
<span id="cb8-20"><a href="#cb8-20"></a>    cbc.fit(train_pool, eval_set<span class="op">=</span>(test_pool), verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-21"><a href="#cb8-21"></a></span>
<span id="cb8-22"><a href="#cb8-22"></a>    score <span class="op">=</span> cbc.get_best_score().get(<span class="st">"validation"</span>).get(<span class="st">"F1"</span>)</span>
<span id="cb8-23"><a href="#cb8-23"></a>    param[<span class="st">"score"</span>] <span class="op">=</span> score</span>
<span id="cb8-24"><a href="#cb8-24"></a>    param[<span class="st">"iterations"</span>] <span class="op">=</span> cbc.get_best_iteration()</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a>    cube_search.append(param)</span>
<span id="cb8-27"><a href="#cb8-27"></a>end <span class="op">=</span> time.time()</span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="bu">print</span>(<span class="ss">f"time lhs: </span><span class="sc">{</span>end <span class="op">-</span> start<span class="sc">:.2f}</span><span class="ss"> sec"</span>)</span>
<span id="cb8-29"><a href="#cb8-29"></a>grid_results <span class="op">=</span> pd.DataFrame(cube_search).sort_values(by<span class="op">=</span><span class="st">"score"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-20" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>grid_results.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="random-search" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="random-search"><span class="header-section-number">2.6</span> Random search</h2>
<p>for depth and iterations the model excpects integers, so <code>randint</code> is used and for subsample and bagging_temperature <code>uniform</code> is used, as the model accepts float values for those.</p>
<div id="cell-22" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>random_sample <span class="op">=</span> np.hstack(</span>
<span id="cb10-2"><a href="#cb10-2"></a>    (</span>
<span id="cb10-3"><a href="#cb10-3"></a>        np.random.randint(<span class="dv">1</span>, <span class="dv">15</span>, (N_SAMPLES, <span class="dv">1</span>)),</span>
<span id="cb10-4"><a href="#cb10-4"></a>        np.random.randint(<span class="dv">1</span>, <span class="dv">1024</span>, (N_SAMPLES, <span class="dv">1</span>)),</span>
<span id="cb10-5"><a href="#cb10-5"></a>        np.random.uniform(<span class="dv">0</span>, <span class="dv">1</span>, (N_SAMPLES, <span class="dv">1</span>)),</span>
<span id="cb10-6"><a href="#cb10-6"></a>        np.random.uniform(<span class="dv">1</span>, <span class="dv">1_000_000</span>, (N_SAMPLES, <span class="dv">1</span>)),</span>
<span id="cb10-7"><a href="#cb10-7"></a>    )</span>
<span id="cb10-8"><a href="#cb10-8"></a>)</span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a>param_combo <span class="op">=</span> <span class="bu">list</span>(</span>
<span id="cb10-11"><a href="#cb10-11"></a>    pd.DataFrame(</span>
<span id="cb10-12"><a href="#cb10-12"></a>        data<span class="op">=</span>random_sample,</span>
<span id="cb10-13"><a href="#cb10-13"></a>        columns<span class="op">=</span>[<span class="st">"depth"</span>, <span class="st">"iterations"</span>, <span class="st">"subsample"</span>, <span class="st">"bagging_temperature"</span>],</span>
<span id="cb10-14"><a href="#cb10-14"></a>    )</span>
<span id="cb10-15"><a href="#cb10-15"></a>    .to_dict(<span class="st">"index"</span>)</span>
<span id="cb10-16"><a href="#cb10-16"></a>    .values()</span>
<span id="cb10-17"><a href="#cb10-17"></a>)</span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a></span>
<span id="cb10-20"><a href="#cb10-20"></a>cube_search <span class="op">=</span> []</span>
<span id="cb10-21"><a href="#cb10-21"></a>start <span class="op">=</span> time.time()</span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="cf">for</span> param <span class="kw">in</span> tqdm(param_combo):</span>
<span id="cb10-23"><a href="#cb10-23"></a>    cbc <span class="op">=</span> CatBoostClassifier(</span>
<span id="cb10-24"><a href="#cb10-24"></a>        <span class="op">**</span>param,</span>
<span id="cb10-25"><a href="#cb10-25"></a>        eval_metric<span class="op">=</span><span class="st">"F1"</span>,</span>
<span id="cb10-26"><a href="#cb10-26"></a>    )</span>
<span id="cb10-27"><a href="#cb10-27"></a>    cbc.fit(train_pool, eval_set<span class="op">=</span>(test_pool), verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-28"><a href="#cb10-28"></a></span>
<span id="cb10-29"><a href="#cb10-29"></a>    score <span class="op">=</span> cbc.get_best_score().get(<span class="st">"validation"</span>).get(<span class="st">"F1"</span>)</span>
<span id="cb10-30"><a href="#cb10-30"></a>    param[<span class="st">"score"</span>] <span class="op">=</span> score</span>
<span id="cb10-31"><a href="#cb10-31"></a>    param[<span class="st">"iterations"</span>] <span class="op">=</span> cbc.get_best_iteration()</span>
<span id="cb10-32"><a href="#cb10-32"></a></span>
<span id="cb10-33"><a href="#cb10-33"></a>    cube_search.append(param)</span>
<span id="cb10-34"><a href="#cb10-34"></a></span>
<span id="cb10-35"><a href="#cb10-35"></a>end <span class="op">=</span> time.time()</span>
<span id="cb10-36"><a href="#cb10-36"></a><span class="bu">print</span>(<span class="ss">f"time random: </span><span class="sc">{</span>end <span class="op">-</span> start<span class="sc">:.2f}</span><span class="ss"> sec"</span>)</span>
<span id="cb10-37"><a href="#cb10-37"></a>random_results <span class="op">=</span> pd.DataFrame(cube_search).sort_values(by<span class="op">=</span><span class="st">"score"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-23" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>random_results.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="lhs-search" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="lhs-search"><span class="header-section-number">2.7</span> LHS search</h2>
<p>when applying the LHS technqiue you need to specify how many dimensions the resulting sample should have and how many samples you want. these are on a different scale than the searchspace that you want to explore, so a scaling is applied to get it to the desired space. afterwhich a type conversion is applied.</p>
<div id="cell-25" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>sampler <span class="op">=</span> qmc.LatinHypercube(d<span class="op">=</span><span class="dv">4</span>, optimization<span class="op">=</span><span class="st">"lloyd"</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a>sample <span class="op">=</span> sampler.random(n<span class="op">=</span>N_SAMPLES)</span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a>l_bounds <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb12-5"><a href="#cb12-5"></a>u_bounds <span class="op">=</span> [<span class="dv">15</span>, <span class="dv">1024</span>, <span class="dv">1</span>, <span class="dv">1000000</span>]</span>
<span id="cb12-6"><a href="#cb12-6"></a>sample_scaled <span class="op">=</span> qmc.scale(sample, l_bounds, u_bounds)</span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="co"># convert to int</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>sample_scaled[:, :<span class="dv">2</span>] <span class="op">=</span> sample_scaled[:, :<span class="dv">2</span>].astype(<span class="bu">int</span>)</span>
<span id="cb12-10"><a href="#cb12-10"></a></span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a>param_combo <span class="op">=</span> <span class="bu">list</span>(</span>
<span id="cb12-13"><a href="#cb12-13"></a>    pd.DataFrame(</span>
<span id="cb12-14"><a href="#cb12-14"></a>        data<span class="op">=</span>sample_scaled,</span>
<span id="cb12-15"><a href="#cb12-15"></a>        columns<span class="op">=</span>[<span class="st">"depth"</span>, <span class="st">"iterations"</span>, <span class="st">"subsample"</span>, <span class="st">"bagging_temperature"</span>],</span>
<span id="cb12-16"><a href="#cb12-16"></a>    )</span>
<span id="cb12-17"><a href="#cb12-17"></a>    .to_dict(<span class="st">"index"</span>)</span>
<span id="cb12-18"><a href="#cb12-18"></a>    .values()</span>
<span id="cb12-19"><a href="#cb12-19"></a>)</span>
<span id="cb12-20"><a href="#cb12-20"></a></span>
<span id="cb12-21"><a href="#cb12-21"></a>cube_search <span class="op">=</span> []</span>
<span id="cb12-22"><a href="#cb12-22"></a>start <span class="op">=</span> time.time()</span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="cf">for</span> param <span class="kw">in</span> param_combo:</span>
<span id="cb12-24"><a href="#cb12-24"></a>    cbc <span class="op">=</span> CatBoostClassifier(</span>
<span id="cb12-25"><a href="#cb12-25"></a>        <span class="op">**</span>param,</span>
<span id="cb12-26"><a href="#cb12-26"></a>        eval_metric<span class="op">=</span><span class="st">"F1"</span>,</span>
<span id="cb12-27"><a href="#cb12-27"></a>    )</span>
<span id="cb12-28"><a href="#cb12-28"></a>    cbc.fit(train_pool, eval_set<span class="op">=</span>(test_pool), verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-29"><a href="#cb12-29"></a></span>
<span id="cb12-30"><a href="#cb12-30"></a>    score <span class="op">=</span> cbc.get_best_score().get(<span class="st">"validation"</span>).get(<span class="st">"F1"</span>)</span>
<span id="cb12-31"><a href="#cb12-31"></a>    param[<span class="st">"score"</span>] <span class="op">=</span> score</span>
<span id="cb12-32"><a href="#cb12-32"></a>    param[<span class="st">"iterations"</span>] <span class="op">=</span> cbc.get_best_iteration()</span>
<span id="cb12-33"><a href="#cb12-33"></a></span>
<span id="cb12-34"><a href="#cb12-34"></a>    cube_search.append(param)</span>
<span id="cb12-35"><a href="#cb12-35"></a></span>
<span id="cb12-36"><a href="#cb12-36"></a>end <span class="op">=</span> time.time()</span>
<span id="cb12-37"><a href="#cb12-37"></a><span class="bu">print</span>(<span class="ss">f"time lhs: </span><span class="sc">{</span>end <span class="op">-</span> start<span class="sc">:.2f}</span><span class="ss"> sec"</span>)</span>
<span id="cb12-38"><a href="#cb12-38"></a>lhs_results <span class="op">=</span> pd.DataFrame(cube_search).sort_values(by<span class="op">=</span><span class="st">"score"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-26" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>lhs_results.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compare-the-three-results" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="compare-the-three-results"><span class="header-section-number">2.8</span> compare the three results</h2>
<div id="cell-28" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>df_all_sample <span class="op">=</span> pd.concat(</span>
<span id="cb14-2"><a href="#cb14-2"></a>    [</span>
<span id="cb14-3"><a href="#cb14-3"></a>        lhs_results.assign(sampling<span class="op">=</span><span class="st">"lhs"</span>),</span>
<span id="cb14-4"><a href="#cb14-4"></a>        random_results.assign(sampling<span class="op">=</span><span class="st">"random"</span>),</span>
<span id="cb14-5"><a href="#cb14-5"></a>        grid_results.assign(sampling<span class="op">=</span><span class="st">"grid"</span>),</span>
<span id="cb14-6"><a href="#cb14-6"></a>    ],</span>
<span id="cb14-7"><a href="#cb14-7"></a>    axis<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb14-8"><a href="#cb14-8"></a>)</span>
<span id="cb14-9"><a href="#cb14-9"></a></span>
<span id="cb14-10"><a href="#cb14-10"></a>df_all_sample <span class="op">=</span> df_all_sample.sort_values(by<span class="op">=</span><span class="st">"score"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-11"><a href="#cb14-11"></a></span>
<span id="cb14-12"><a href="#cb14-12"></a>df_all_sample.head(n<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="bonus-optuna-hyperparameter-optimization-framework" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Bonus: Optuna hyperparameter optimization framework</h1>
<p><a href="https://optuna.readthedocs.io/en/stable/">Optuna</a> bayes hyperparameter tuning, tradeoff between explotation and exploration</p>
<div id="cell-31" class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">def</span> obj_all(trial) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb15-2"><a href="#cb15-2"></a>    params <span class="op">=</span> {</span>
<span id="cb15-3"><a href="#cb15-3"></a>        <span class="st">"depth"</span>: trial.suggest_int(name<span class="op">=</span><span class="st">"depth"</span>, low<span class="op">=</span><span class="dv">1</span>, high<span class="op">=</span><span class="dv">15</span>),</span>
<span id="cb15-4"><a href="#cb15-4"></a>        <span class="st">"iterations"</span>: trial.suggest_int(<span class="st">"iterations"</span>, <span class="dv">1</span>, <span class="dv">1024</span>),</span>
<span id="cb15-5"><a href="#cb15-5"></a>        <span class="st">"subsample"</span>: trial.suggest_float(<span class="st">"subsample"</span>, <span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb15-6"><a href="#cb15-6"></a>        <span class="st">"bagging_temperature"</span>: trial.suggest_float(</span>
<span id="cb15-7"><a href="#cb15-7"></a>            <span class="st">"bagging_temperature"</span>, <span class="fl">1e-10</span>, <span class="dv">1_000_000</span>, log<span class="op">=</span><span class="va">True</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>        ),</span>
<span id="cb15-9"><a href="#cb15-9"></a>    }</span>
<span id="cb15-10"><a href="#cb15-10"></a></span>
<span id="cb15-11"><a href="#cb15-11"></a>    cbc <span class="op">=</span> CatBoostClassifier(</span>
<span id="cb15-12"><a href="#cb15-12"></a>        <span class="op">**</span>params,</span>
<span id="cb15-13"><a href="#cb15-13"></a>        eval_metric<span class="op">=</span><span class="st">"F1"</span>,</span>
<span id="cb15-14"><a href="#cb15-14"></a>    )</span>
<span id="cb15-15"><a href="#cb15-15"></a>    cbc.fit(train_pool, eval_set<span class="op">=</span>(test_pool), verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-16"><a href="#cb15-16"></a></span>
<span id="cb15-17"><a href="#cb15-17"></a>    <span class="cf">return</span> cbc.get_best_score().get(<span class="st">"validation"</span>).get(<span class="st">"F1"</span>)</span>
<span id="cb15-18"><a href="#cb15-18"></a></span>
<span id="cb15-19"><a href="#cb15-19"></a></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">10</span>)</span>
<span id="cb15-21"><a href="#cb15-21"></a></span>
<span id="cb15-22"><a href="#cb15-22"></a>start <span class="op">=</span> time.time()</span>
<span id="cb15-23"><a href="#cb15-23"></a>study <span class="op">=</span> optuna.create_study(study_name<span class="op">=</span><span class="st">"all-in"</span>, direction<span class="op">=</span><span class="st">"maximize"</span>)</span>
<span id="cb15-24"><a href="#cb15-24"></a>study.optimize(</span>
<span id="cb15-25"><a href="#cb15-25"></a>    obj_all,</span>
<span id="cb15-26"><a href="#cb15-26"></a>    n_trials<span class="op">=</span>N_SAMPLES,</span>
<span id="cb15-27"><a href="#cb15-27"></a>)</span>
<span id="cb15-28"><a href="#cb15-28"></a></span>
<span id="cb15-29"><a href="#cb15-29"></a>end <span class="op">=</span> time.time()</span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">10</span>)</span>
<span id="cb15-31"><a href="#cb15-31"></a><span class="bu">print</span>(<span class="ss">f"time all-in: </span><span class="sc">{</span>end <span class="op">-</span> start<span class="sc">:.2f}</span><span class="ss"> sec"</span>)</span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>study<span class="sc">.</span>best_params<span class="op">=</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-33"><a href="#cb15-33"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>study<span class="sc">.</span>best_value<span class="op">=</span><span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-33" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="im">import</span> gif</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-34" class="cell" data-execution_count="90">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="90">
<div>
<figure class="figure">
<p><img src="stepcat_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="102">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="at">@gif.frame</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="kw">def</span> frame(sub_lhs_sample):</span>
<span id="cb18-3"><a href="#cb18-3"></a>    _, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb18-4"><a href="#cb18-4"></a>    curr_ax <span class="op">=</span> ax</span>
<span id="cb18-5"><a href="#cb18-5"></a>    sns.histplot(</span>
<span id="cb18-6"><a href="#cb18-6"></a>        x<span class="op">=</span>sub_lhs_sample[:, <span class="dv">0</span>],</span>
<span id="cb18-7"><a href="#cb18-7"></a>        y<span class="op">=</span>sub_lhs_sample[:, <span class="dv">1</span>],</span>
<span id="cb18-8"><a href="#cb18-8"></a>        bins<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb18-9"><a href="#cb18-9"></a>        ax<span class="op">=</span>curr_ax,</span>
<span id="cb18-10"><a href="#cb18-10"></a>        cbar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-11"><a href="#cb18-11"></a>        thresh<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb18-12"><a href="#cb18-12"></a>    )</span>
<span id="cb18-13"><a href="#cb18-13"></a>    sns.scatterplot(</span>
<span id="cb18-14"><a href="#cb18-14"></a>        x<span class="op">=</span>sub_lhs_sample[:, <span class="dv">0</span>],</span>
<span id="cb18-15"><a href="#cb18-15"></a>        y<span class="op">=</span>sub_lhs_sample[:, <span class="dv">1</span>],</span>
<span id="cb18-16"><a href="#cb18-16"></a>        ax<span class="op">=</span>curr_ax,</span>
<span id="cb18-17"><a href="#cb18-17"></a>        color<span class="op">=</span><span class="st">"tab:orange"</span>,</span>
<span id="cb18-18"><a href="#cb18-18"></a>        s<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb18-19"><a href="#cb18-19"></a>    )</span>
<span id="cb18-20"><a href="#cb18-20"></a>    curr_ax.set_xticks([])</span>
<span id="cb18-21"><a href="#cb18-21"></a>    curr_ax.set_yticks([])</span>
<span id="cb18-22"><a href="#cb18-22"></a></span>
<span id="cb18-23"><a href="#cb18-23"></a></span>
<span id="cb18-24"><a href="#cb18-24"></a><span class="co"># frame(lhs_sample)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-36" class="cell" data-execution_count="106">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>sampler <span class="op">=</span> qmc.LatinHypercube(d<span class="op">=</span><span class="dv">2</span>, optimization<span class="op">=</span><span class="st">"lloyd"</span>)</span>
<span id="cb19-2"><a href="#cb19-2"></a>lhs_sample <span class="op">=</span> sampler.random(n<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a>n_slices <span class="op">=</span> <span class="dv">33</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>inc <span class="op">=</span> lhs_sample.shape[<span class="dv">0</span>] <span class="op">//</span> n_slices</span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a>prev_i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>all_frames <span class="op">=</span> []</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(inc, lhs_sample.shape[<span class="dv">0</span>], inc):</span>
<span id="cb19-10"><a href="#cb19-10"></a>    all_frames.append(frame(lhs_sample[prev_i:i, :]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-37" class="cell" data-execution_count="107">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># add the bounce</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co"># all_frames.extend([all_frames[-1] for _ in range(2)])</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>all_frames.extend(all_frames[::<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-38" class="cell" data-execution_count="108">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>gif.save(all_frames, <span class="st">"artifacts/dots.gif"</span>, duration<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jope35\.github\.io\/hypershotgun-blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>